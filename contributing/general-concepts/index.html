<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>General concepts · Dark Documentation</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="## Editor vs Production (how code runs)"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="General concepts · Dark Documentation"/><meta property="og:type" content="website"/><meta property="og:url" content="https://darklang.github.io/docs/"/><meta property="og:description" content="## Editor vs Production (how code runs)"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/docs/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-159199190-1"></script><script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments); }
              gtag('js', new Date());
              gtag('config', 'UA-159199190-1');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/docs/js/scrollSpy.js"></script><link rel="stylesheet" href="/docs/css/main.css"/><script src="/docs/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/docs/"><img class="logo" src="/docs/img/favicon.ico" alt="Dark Documentation"/><h2 class="headerTitleWithLogo">Dark Documentation</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/introduction" target="_self">Documentation</a></li><li class=""><a href="/docs/tutorials/tutorial-intro" target="_self">Tutorials &amp; Samples</a></li><li class=""><a href="/docs/slack-apps/slack-intro" target="_self">Building Slack Apps</a></li><li class="siteNavGroupActive"><a href="/docs/contributing/getting-started" target="_self">Contributing</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Working in the Dark repo</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Your First Contribution</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/contributing/getting-started">Getting started</a></li><li class="navListItem"><a class="navItem" href="/docs/contributing/setting-up-the-repo">Setting up the Dark repo</a></li><li class="navListItem"><a class="navItem" href="/docs/contributing/adding-your-first-test">Adding your first test</a></li><li class="navListItem"><a class="navItem" href="/docs/contributing/making-your-first-pull-request">Making your first Pull Request</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Your Next Contributions</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/contributing/next-contribution">Your next contribution</a></li><li class="navListItem"><a class="navItem" href="/docs/contributing/if-you-dont-know-ocaml">If you don&#x27;t know OCaml</a></li><li class="navListItem"><a class="navItem" href="/docs/contributing/adding-a-function">Adding a built-in function</a></li><li class="navListItem"><a class="navItem" href="/docs/contributing/adding-a-language-feature">Adding a language feature</a></li><li class="navListItem"><a class="navItem" href="/docs/contributing/adding-a-refactoring">Adding a refactoring</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Working in the Dark repo</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/contributing/ocaml-for-dark-developers">OCaml for Dark developers</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/contributing/general-concepts">General concepts</a></li><li class="navListItem"><a class="navItem" href="/docs/contributing/tour-of-editor">A tour of the Editor</a></li><li class="navListItem"><a class="navItem" href="/docs/contributing/tour-of-backend">A tour of the Backend</a></li><li class="navListItem"><a class="navItem" href="/docs/contributing/repo-layout">Repository directory structure</a></li><li class="navListItem"><a class="navItem" href="/docs/contributing/glossary">Glossary</a></li><li class="navListItem"><a class="navItem" href="/docs/contributing/debugging">Debugging</a></li><li class="navListItem"><a class="navItem" href="/docs/contributing/making-a-pull-request">Making a Pull Request</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">General concepts</h1></header><article><div><span><h2><a class="anchor" aria-hidden="true" id="editor-vs-production-how-code-runs"></a><a href="#editor-vs-production-how-code-runs" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Editor vs Production (how code runs)</h2>
<p>Code runs in two places in Dark, in the Editor, and in Production. In
production, we have a Kubernetes cluster of interpreters with HTTP servers
which are connected to a database, connected to the internet via Google Cloud
infrastructure, that run Dark programs.</p>
<p>When requests are made in production we save their inputs and intermediate
values (combined, these form a &quot;trace&quot;, discussed below). Those are sent to the client.</p>
<p>The Dark interpreter is also compiled to Javascript and is available in the
browser in the client. The traces are sent to the JS-compiled interpreter,
which uses their results to fill in for functions which can't be run on the
client (such as DB functions).</p>
<h2><a class="anchor" aria-hidden="true" id="traces--live-values"></a><a href="#traces--live-values" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Traces &amp; Live values</h2>
<p>When a request is made to a production server, the inputs (typically a HTTP
request) are saved. We also save intermediate results of functions which are
called during the request. Together, these comprise a trace. Traces are shown
in the editor and users can choose between them.</p>
<h2><a class="anchor" aria-hidden="true" id="toplevels"></a><a href="#toplevels" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Toplevels</h2>
<p>&quot;Toplevel&quot; is the generic name for a part of a Dark program, either a handler
(whether a HTTP handler, a Cron or a worker), a function, a type, or a database.</p>
<p>Structural toplevels are toplevels which are part of the structure of your
program: handlers and DBs. These live on the canvas.</p>
<p>Other toplevels are non-structural, and they don't live on the canvas or really
anywhere. We have started to affectionately refer to the display for these as
the &quot;function space&quot;. (There is a design for what should happen here, but we
have not done it yet).</p>
<h2><a class="anchor" aria-hidden="true" id="the-path-of-an-edit"></a><a href="#the-path-of-an-edit" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The path of an edit</h2>
<p>Most characters that you type are immediately saved in our production database (in, according to our claim, 50ms). Edits are either made to program code, which is part of the &quot;Fluid&quot; editing system, or to handlers, databases, function parameters, or similar metadata, which is part of the &quot;Forms&quot; editing system (originally, all edits were of the &quot;forms&quot; variety - the name was added post-hoc to differentiate it from &quot;fluid&quot;).</p>
<p>For Fluid, this is the journey:</p>
<ul>
<li>the event processed by <code>FluidKeyboard.ml</code>, creating a <code>FluidMsg</code></li>
<li>Fluid.ml recognized the <code>FluidMsg</code>, calling <code>updateKey</code></li>
<li><code>updateKey</code> looks at the current caret position, and at the &quot;tokens&quot; before
and after the caret, to figure out what's happening</li>
<li><code>updateKey</code> makes a transformation based on whatever it decided</li>
<li>the AST for that code is transformed</li>
<li><code>FluidAutocomplete</code> may be regenerated, if necessary</li>
<li>the browser's animation event fires, causing a re-render. The AST is
&quot;tokenized&quot;, essentially pretty-printing it as HTML, which then renders</li>
<li>an API call is made to send the change to the server (detailed below)</li>
</ul>
<p>For forms, the journey is similar:</p>
<ul>
<li>the event is processed by <code>KeyPress.ml</code></li>
<li>the contents of <code>m.complete.value</code> are updated (this is where the value in
the forms box is stored)</li>
<li>the <code>Autocomplete</code> values are regenerated</li>
<li>after pressing enter, or clicking away, the change is made</li>
<li>an API call is made to send the change to the server (detailed below)</li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="sending-the-change-to-the-server"></a><a href="#sending-the-change-to-the-server" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sending the change to the server</h3>
<p>When a change is made, typically an <code>AddOp</code> <code>modification</code> is made. That
<code>modification</code> is returned by many of the functions that edit programs, and
it's processed in <code>Main.ml</code>. This passes into <code>API.ml</code>, where it serializes the
<code>Op</code> change into a JSON via encoders (see <code>Enconders.ml</code> and <code>Decoders.ml</code>).</p>
<p>The change is accepted by <code>api.ml</code> in the backend, where it is decoded, applied
to the program, and then saved into the database. Saving the program involves a
special binary serialization format, in <code>Serialization_format.ml</code>.</p>
<p>After being saved, it is sent to <code>Stroller</code>, a &quot;sidecar&quot; process in Rust that
sends it to Pusher.com, the websockets vendor we use. This is sent to other
clients which then update their programs. It is also sent to the original
editor, who ignores it.</p>
<h2><a class="anchor" aria-hidden="true" id="asts"></a><a href="#asts" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ASTs</h2>
<p>An &quot;AST&quot; is an &quot;Abstract syntax tree&quot;. The simple explanation is that it's a
set of &quot;classes&quot; and &quot;objects&quot; representing programs. (Abstract syntax tree
means the programs representation (the &quot;syntax tree&quot;) without the annoying
syntactic details like commas and semi-colons (hence &quot;abstract&quot;)).</p>
<p>In Dark, it's defined in <code>FluidExpression.ml</code>, and at time of writing looks like this:</p>
<pre><code class="hljs css language-ocaml"><span class="hljs-keyword">type</span> sendToRail =
  | <span class="hljs-type">Rail</span>
  | <span class="hljs-type">NoRail</span>

<span class="hljs-keyword">type</span> expr  =
  | <span class="hljs-type">EInteger</span> <span class="hljs-keyword">of</span> id * <span class="hljs-built_in">string</span>
  | <span class="hljs-type">EBool</span> <span class="hljs-keyword">of</span> id * <span class="hljs-built_in">bool</span>
  | <span class="hljs-type">EString</span> <span class="hljs-keyword">of</span> id * <span class="hljs-built_in">string</span>
  | <span class="hljs-type">EFloat</span> <span class="hljs-keyword">of</span> id * <span class="hljs-built_in">string</span> * <span class="hljs-built_in">string</span>
  | <span class="hljs-type">ENull</span> <span class="hljs-keyword">of</span> id
  | <span class="hljs-type">EBlank</span> <span class="hljs-keyword">of</span> id
  | <span class="hljs-type">ELet</span> <span class="hljs-keyword">of</span> id * <span class="hljs-built_in">string</span> * expr * expr
  | <span class="hljs-type">EIf</span> <span class="hljs-keyword">of</span> id * expr * expr * expr
  | <span class="hljs-type">EBinOp</span> <span class="hljs-keyword">of</span> id * <span class="hljs-built_in">string</span> * expr * expr * sendToRail
  | <span class="hljs-type">ELambda</span> <span class="hljs-keyword">of</span> id * (id * <span class="hljs-built_in">string</span>) <span class="hljs-built_in">list</span> * expr
  | <span class="hljs-type">EFieldAccess</span> <span class="hljs-keyword">of</span> id * expr * <span class="hljs-built_in">string</span>
  | <span class="hljs-type">EVariable</span> <span class="hljs-keyword">of</span> id * <span class="hljs-built_in">string</span>
  | <span class="hljs-type">EFnCall</span> <span class="hljs-keyword">of</span> id * <span class="hljs-built_in">string</span> * expr <span class="hljs-built_in">list</span> * sendToRail
  
  | <span class="hljs-type">EPartial</span> <span class="hljs-keyword">of</span> id * <span class="hljs-built_in">string</span> * expr
  | <span class="hljs-type">ERightPartial</span> <span class="hljs-keyword">of</span> id * <span class="hljs-built_in">string</span> * expr
  | <span class="hljs-type">ELeftPartial</span> <span class="hljs-keyword">of</span> id * <span class="hljs-built_in">string</span> * expr
  | <span class="hljs-type">EList</span> <span class="hljs-keyword">of</span> id * expr <span class="hljs-built_in">list</span>
  | <span class="hljs-type">ERecord</span> <span class="hljs-keyword">of</span> id * (<span class="hljs-built_in">string</span> * expr) <span class="hljs-built_in">list</span>
  | <span class="hljs-type">EPipe</span> <span class="hljs-keyword">of</span> id * expr <span class="hljs-built_in">list</span>
  | <span class="hljs-type">EConstructor</span> <span class="hljs-keyword">of</span> id * <span class="hljs-built_in">string</span> * expr <span class="hljs-built_in">list</span>
  | <span class="hljs-type">EMatch</span> <span class="hljs-keyword">of</span> id * expr * (pattern * expr) <span class="hljs-built_in">list</span>
  | <span class="hljs-type">EPipeTarget</span> <span class="hljs-keyword">of</span> id
  | <span class="hljs-type">EFeatureFlag</span> <span class="hljs-keyword">of</span> id * <span class="hljs-built_in">string</span> * expr * expr * expr

<span class="hljs-keyword">type</span> pattern =
  | <span class="hljs-type">FPVariable</span> <span class="hljs-keyword">of</span> id * id * <span class="hljs-built_in">string</span>
  | <span class="hljs-type">FPConstructor</span> <span class="hljs-keyword">of</span> id * id * <span class="hljs-built_in">string</span> * pattern <span class="hljs-built_in">list</span>
  | <span class="hljs-type">FPInteger</span> <span class="hljs-keyword">of</span> id * id * <span class="hljs-built_in">string</span>
  | <span class="hljs-type">FPBool</span> <span class="hljs-keyword">of</span> id * id * <span class="hljs-built_in">bool</span>
  | <span class="hljs-type">FPString</span> <span class="hljs-keyword">of</span> id * id * <span class="hljs-built_in">string</span>
  | <span class="hljs-type">FPFloat</span> <span class="hljs-keyword">of</span> id * id * <span class="hljs-built_in">string</span> * <span class="hljs-built_in">string</span>
  | <span class="hljs-type">FPNull</span> <span class="hljs-keyword">of</span> id * id
  | <span class="hljs-type">FPBlank</span> <span class="hljs-keyword">of</span> id * id
</code></pre>
<p>This isn't exactly right, but it's close. There's definitions for literals like
ints and strings, for definitions like <code>let</code>s, for function calls with <code>EBinOp</code>
and <code>EFnCall</code>, and also for various editor-specific intermediate states like
<code>EPartial</code> and <code>ERightPartial</code>.</p>
<p>Each expression has an <code>id</code> that is used to uniquely refer to the expression.
If an ID is duplicated by accident, the editor will act weirdly, but the
program will work fine.</p>
<p><code>FluidPattern.ml</code> and <code>FluidExpression.ml</code> also contain functions for changing
them easily, either by changing the by ID or by traversing across the entire
structure. Traversing the structure is generally pretty fast.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/contributing/ocaml-for-dark-developers"><span class="arrow-prev">← </span><span>OCaml for Dark developers</span></a><a class="docs-next button" href="/docs/contributing/tour-of-editor"><span>A tour of the Editor</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#editor-vs-production-how-code-runs">Editor vs Production (how code runs)</a></li><li><a href="#traces--live-values">Traces &amp; Live values</a></li><li><a href="#toplevels">Toplevels</a></li><li><a href="#the-path-of-an-edit">The path of an edit</a><ul class="toc-headings"><li><a href="#sending-the-change-to-the-server">Sending the change to the server</a></li></ul></li><li><a href="#asts">ASTs</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="copyright">Copyright © 2020 Dark</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '1e1c6adb6b62f53c456dc70e833c2c26',
                indexName: 'darklang',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>